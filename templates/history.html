<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssiScan | Database History</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1a0505; --primary: #2b0c0c; --gold: #d4af37; --text-light: #e0e0e0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-light); padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #442020; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { font-family: 'Cinzel', serif; color: var(--gold); margin: 0; }
        .btn-back { text-decoration: none; color: var(--gold); border: 1px solid var(--gold); padding: 8px 15px; border-radius: 5px; }
        .btn-back:hover { background: var(--gold); color: #000; }
        table { width: 100%; border-collapse: collapse; background: var(--primary); font-size: 12px; border-radius: 5px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #442020; }
        th { color: var(--gold); text-transform: uppercase; background: rgba(0,0,0,0.2); }
        .doc-link { color: #4da6ff; text-decoration: none; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: rgba(77,166,255,0.1); }
        .doc-link:hover { background: #4da6ff; color: white; }
        .no-doc { color: #555; font-style: italic; }
        .btn-del { color: #ff4d4d; cursor: pointer; background: none; border: none; font-size: 14px; }
        #searchBox { padding: 10px; width: 300px; background: rgba(255,255,255,0.05); border: 1px solid #442020; color: white; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Student Records</h1>
        <input type="text" id="searchBox" placeholder="Search Name..." onkeyup="filterTable()">
        <a href="/" class="btn-back"><i class="fas fa-arrow-left"></i> Back to Scanner</a>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Sex</th><th>Birthdate</th>
                <th>PSA</th><th>Form 137</th><th>Form 138</th><th>Good Moral</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="recordsTable">
            <tr><td colspan="9" style="text-align:center; padding: 20px;">Loading data...</td></tr>
        </tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadRecords();
        });

        async function loadRecords() {
            try {
                const res = await fetch('/get-records');
                if (!res.ok) throw new Error("Failed to fetch records");
                
                const data = await res.json();
                console.log("Records received:", data); // Check Console (F12) if empty
                renderTable(data.records || []);
            } catch (e) { 
                console.error(e);
                document.getElementById('recordsTable').innerHTML = "<tr><td colspan='9' style='text-align:center; color:red;'>Error loading data. Please refresh.</td></tr>";
            }
        }

        function getFileLink(path) {
            if (!path || path === "null" || path === "") return '<span class="no-doc">--</span>';
            const filename = path.split(/[\\/]/).pop();
            return `<a href="/uploads/${filename}" target="_blank" class="doc-link">View</a>`;
        }

        function renderTable(records) {
            const tbody = document.getElementById('recordsTable');
            tbody.innerHTML = "";
            
            if(records.length === 0) {
                tbody.innerHTML = "<tr><td colspan='9' style='text-align:center; padding:20px;'>No records found in Database.</td></tr>";
                return;
            }

            records.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td style="color:white;font-weight:bold;">${row.name}</td>
                    <td>${row.sex}</td>
                    <td>${row.birthdate}</td>
                    <td>${getFileLink(row.image_path)}</td>
                    <td>${getFileLink(row.form137_path)}</td>
                    <td>${getFileLink(row.form138_path)}</td>
                    <td>${getFileLink(row.goodmoral_path)}</td>
                    <td><button class="btn-del" onclick="deleteRecord(${row.id})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteRecord(id) {
            if(!confirm("Are you sure you want to delete this record permanently?")) return;
            try {
                const res = await fetch(`/delete/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert("Record deleted!");
                    loadRecords(); // Reload table without refreshing page
                } else {
                    alert("Failed to delete.");
                }
            } catch (e) {
                console.error(e);
                alert("Error deleting record.");
            }
        }

        function filterTable() {
            const filter = document.getElementById("searchBox").value.toUpperCase();
            const rows = document.getElementById("recordsTable").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let td = rows[i].getElementsByTagName("td")[1]; // Name column
                if (td) {
                    rows[i].style.display = (td.innerText.toUpperCase().indexOf(filter) > -1) ? "" : "none";
                }
            }
        }
    </script>
</body>
</html>
