<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssiScan | Premium Dual Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f0404;
            --panel-bg: rgba(20, 5, 5, 0.6); 
            --primary-gold: #d4af37;
            --bright-gold: #ffdf80;
            --text-main: #f0f0f0;
            --text-muted: #8a7a7a;
            --input-bg: rgba(255, 255, 255, 0.05);
            --border-dim: rgba(212, 175, 55, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 50% 50%, #1a0505 0%, #000000 100%);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- ANIMATIONS --- */
        @keyframes scanLaser { 
            0% { top: 0%; opacity: 0; box-shadow: 0 0 5px var(--primary-gold); } 
            20% { opacity: 1; }
            50% { box-shadow: 0 0 20px var(--bright-gold); }
            100% { top: 100%; opacity: 0; } 
        }

        /* --- SIDEBAR (Left Navigation) --- */
        .sidebar {
            width: 250px;
            background: rgba(10, 2, 2, 0.95);
            border-right: 1px solid var(--border-dim);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            z-index: 20;
        }
        .brand-title { font-family: 'Cinzel', serif; color: var(--primary-gold); font-size: 28px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .brand-subtitle { font-size: 9px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; padding-bottom: 20px; border-bottom: 1px solid var(--border-dim); }
        
        .btn-nav { margin-top: auto; background: rgba(212, 175, 55, 0.05); border: 1px solid var(--border-dim); color: var(--primary-gold); padding: 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-nav:hover { background: var(--primary-gold); color: #000; }

        /* --- MAIN DUAL SCAN AREA --- */
        .main-scan { 
            flex: 1; 
            padding: 20px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            position: relative; 
        }

        .dual-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
            max-width: 1100px;
            height: 80%;
        }

        /* --- SCANNER CARD --- */
        .scan-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .card-title {
            font-family: 'Cinzel', serif;
            color: var(--primary-gold);
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scan-frame { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            min-height: 350px;
            border: 1px solid var(--border-dim); 
            background: rgba(0, 0, 0, 0.3); 
            border-radius: 6px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            transition: 0.3s; 
            overflow: hidden; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }
        .scan-frame:hover { border-color: var(--primary-gold); box-shadow: 0 0 20px rgba(212, 175, 55, 0.1); }
        
        /* Image Preview inside frame */
        .img-preview { width: 100%; height: 100%; object-fit: contain; display: none; position: absolute; z-index: 1; background: #000; }
        
        /* Corners */
        .corner { position: absolute; width: 20px; height: 20px; border-color: var(--primary-gold); border-style: solid; transition: 0.3s; z-index: 5; pointer-events: none; }
        .tl { top: 10px; left: 10px; border-width: 2px 0 0 2px; }
        .tr { top: 10px; right: 10px; border-width: 2px 2px 0 0; }
        .bl { bottom: 10px; left: 10px; border-width: 0 0 2px 2px; }
        .br { bottom: 10px; right: 10px; border-width: 0 2px 2px 0; }
        .scan-frame:hover .corner { width: 30px; height: 30px; }

        /* Placeholder Content */
        .upload-placeholder { text-align: center; color: var(--text-muted); z-index: 2; pointer-events: none; }
        .upload-placeholder i { font-size: 30px; color: var(--border-dim); margin-bottom: 10px; }
        
        /* Laser Effect */
        .scan-laser { position: absolute; width: 100%; height: 2px; background: var(--bright-gold); box-shadow: 0 0 15px var(--primary-gold); z-index: 10; display: none; animation: scanLaser 1.5s infinite linear; }

        /* --- RESULTS PANEL (Below Scanners) --- */
        .result-box {
            width: 100%;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-dim);
            border-radius: 4px;
            padding: 15px;
            font-size: 12px;
            color: #ccc;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }
        .result-label { color: var(--primary-gold); font-weight: bold; margin-right: 5px; }

        /* --- ACTION BAR (Bottom) --- */
        .action-bar {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-save-all { 
            background: linear-gradient(90deg, #d4af37, #f3d576);
            color: #0f0404;
            padding: 15px 60px; 
            font-family: 'Cinzel', serif; 
            font-weight: bold;
            letter-spacing: 2px; 
            border: none;
            border-radius: 4px;
            cursor: pointer; 
            transition: 0.3s; 
            font-size: 16px; 
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            opacity: 0.5; /* Disabled look initially */
            pointer-events: none;
        }
        .btn-save-all.active { opacity: 1; pointer-events: all; }
        .btn-save-all:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(212, 175, 55, 0.6); }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; flex-direction: row; justify-content: space-between; align-items: center; padding: 15px; position: sticky; top: 0; }
            .brand-subtitle { display: none; }
            .dual-container { grid-template-columns: 1fr; height: auto; padding-bottom: 50px; }
            .scan-frame { height: 300px; }
            .main-scan { height: auto; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div>
            <div class="brand-title">ASSISCAN</div>
            <div class="brand-subtitle">University of Batangas Lipa</div>
        </div>
        <a href="history.html" class="btn-nav"><i class="fas fa-database"></i> VIEW RECORDS</a>
    </nav>

    <main class="main-scan">
        
        <div class="dual-container">
            
            <div class="scan-card">
                <div class="card-title"><i class="fas fa-baby"></i> STEP 1: PSA BIRTH CERT.</div>
                
                <div class="scan-frame" onclick="document.getElementById('psaInput').click()">
                    <div class="scan-laser" id="psaLaser"></div>
                    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                    
                    <div class="upload-placeholder" id="psaPlaceholder">
                        <i class="fas fa-id-card"></i>
                        <div style="font-size: 11px; letter-spacing: 1px;">TAP TO SCAN PSA</div>
                    </div>
                    
                    <img id="psaPreview" class="img-preview">
                    <input type="file" id="psaInput" hidden accept="image/*" onchange="processPSA(this)">
                </div>

                <div class="result-box" id="psaResultDisplay">
                    <i style="color: #555;">Waiting for PSA scan...</i>
                </div>
            </div>

            <div class="scan-card">
                <div class="card-title"><i class="fas fa-school"></i> STEP 2: FORM 137 / SF10</div>
                
                <div class="scan-frame" onclick="document.getElementById('f137Input').click()">
                    <div class="scan-laser" id="f137Laser"></div>
                    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                    
                    <div class="upload-placeholder" id="f137Placeholder">
                        <i class="fas fa-file-contract"></i>
                        <div style="font-size: 11px; letter-spacing: 1px;">TAP TO SCAN FORM 137</div>
                    </div>
                    
                    <img id="f137Preview" class="img-preview">
                    <input type="file" id="f137Input" hidden accept="image/*" onchange="processForm137(this)">
                </div>

                <div class="result-box" id="f137ResultDisplay">
                    <i style="color: #555;">Waiting for School Record...</i>
                </div>
            </div>

        </div>

        <div class="action-bar">
            <button id="saveBtn" class="btn-save-all" onclick="saveCombinedRecord()">
                SAVE COMPLETE RECORD
            </button>
        </div>

    </main>

    <script>
        let psaData = null;
        let f137Data = null;
        let psaImagePath = null;
        let f137ImagePath = null;

        // --- 1. PROCESS PSA ---
        async function processPSA(input) {
            const file = input.files[0];
            if (!file) return;

            // UI Updates
            showPreview(file, 'psaPreview', 'psaPlaceholder');
            toggleLaser('psaLaser', true);
            document.getElementById('psaResultDisplay').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing PSA Document...';

            const formData = new FormData();
            formData.append('imageFile', file);

            try {
                const res = await fetch('/extract', { method: 'POST', body: formData });
                const data = await res.json();
                toggleLaser('psaLaser', false);

                if (data.error) {
                    document.getElementById('psaResultDisplay').innerHTML = `<span style="color:red">Error: ${data.error}</span>`;
                } else {
                    psaData = data.structured_data;
                    psaImagePath = data.image_path;
                    
                    // Display Clean Data
                    document.getElementById('psaResultDisplay').innerHTML = `
                        <div><span class="result-label">Name:</span> ${psaData.Name}</div>
                        <div><span class="result-label">Sex:</span> ${psaData.Sex}</div>
                        <div><span class="result-label">B-day:</span> ${psaData.Birthdate}</div>
                        <div><span class="result-label">Mother:</span> ${psaData.Mother_MaidenName}</div>
                    `;
                    checkReady();
                }
            } catch (e) {
                toggleLaser('psaLaser', false);
                alert("Scan failed. Check connection.");
            }
        }

        // --- 2. PROCESS FORM 137 ---
        async function processForm137(input) {
            const file = input.files[0];
            if (!file) return;

            // UI Updates
            showPreview(file, 'f137Preview', 'f137Placeholder');
            toggleLaser('f137Laser', true);
            document.getElementById('f137ResultDisplay').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting School Data...';

            const formData = new FormData();
            formData.append('imageFile', file);

            try {
                const res = await fetch('/extract-form137', { method: 'POST', body: formData });
                const data = await res.json();
                toggleLaser('f137Laser', false);

                if (data.error) {
                    document.getElementById('f137ResultDisplay').innerHTML = `<span style="color:red">Error: ${data.error}</span>`;
                } else {
                    f137Data = data.structured_data;
                    f137ImagePath = data.image_path;

                    // Display Clean Data
                    document.getElementById('f137ResultDisplay').innerHTML = `
                        <div><span class="result-label">LRN:</span> ${f137Data.lrn}</div>
                        <div><span class="result-label">School:</span> ${f137Data.school_name}</div>
                        <div><span class="result-label">Addr:</span> ${f137Data.school_address}</div>
                    `;
                    checkReady();
                }
            } catch (e) {
                toggleLaser('f137Laser', false);
                alert("Scan failed.");
            }
        }

        // --- UTILS ---
        function showPreview(file, imgId, placeholderId) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById(placeholderId).style.display = 'none';
            }
            reader.readAsDataURL(file);
        }

        function toggleLaser(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function checkReady() {
            const btn = document.getElementById('saveBtn');
            // Enable save button only if PSA is present (F137 is optional but recommended)
            if (psaData) {
                btn.classList.add('active');
                btn.innerText = f137Data ? "SAVE COMPLETE RECORD" : "SAVE (PSA ONLY)";
            }
        }

        // --- 3. SAVE COMBINED ---
        async function saveCombinedRecord() {
            const btn = document.getElementById('saveBtn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SAVING DATABASE...';
            
            const payload = {
                // PSA
                name: psaData.Name,
                sex: psaData.Sex,
                birthdate: psaData.Birthdate,
                birthplace: psaData.PlaceOfBirth,
                mother_name: psaData.Mother_MaidenName,
                mother_citizenship: psaData.Mother_Citizenship,
                mother_occupation: psaData.Mother_Occupation,
                father_name: psaData.Father_Name,
                father_citizenship: psaData.Father_Citizenship,
                father_occupation: psaData.Father_Occupation,
                psa_image_path: psaImagePath,
                
                // Form 137 (Pass empty strings if not scanned)
                lrn: f137Data ? f137Data.lrn : "",
                school_name: f137Data ? f137Data.school_name : "",
                school_address: f137Data ? f137Data.school_address : "",
                f137_image_path: f137ImagePath
            };

            try {
                const res = await fetch('/save-record', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                
                if (result.status === 'success') {
                    alert("âœ… Success! Record stored in database.");
                    window.location.href = "/history.html";
                } else {
                    alert("Database Error: " + result.error);
                    btn.innerText = "TRY AGAIN";
                }
            } catch (e) {
                alert("Network Error");
            }
        }
    </script>
</body>
</html>
